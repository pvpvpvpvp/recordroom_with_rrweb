<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RecordRoom Week5 SDK Demo</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system; padding: 20px; line-height: 1.4; }
    button, input { padding: 10px 14px; margin-right: 8px; margin-bottom: 8px; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
    .box { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-top: 12px; }
    .row { margin: 6px 0; }
    a { word-break: break-all; }
    .small { color: #666; font-size: 12px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    .tabs a { margin-right: 10px; text-decoration: none; }
    .tabs a.active { font-weight: 700; text-decoration: underline; }
    .pill { display: inline-block; background: #f4f4f4; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
  </style>
  <script src="/js/i18n.js"></script>
</head>
<body>
  <h1><span data-i18n-en="Week5: Auto recording via SDK (app integration)" data-i18n-ko="Week5: SDK 방식으로 자동 기록(앱에 붙이는 형태)">Week5: SDK 방식으로 자동 기록(앱에 붙이는 형태)</span></h1>

  <div class="box">
    <div class="row tabs">
      <a href="/demo"><span data-i18n-en="Demo (Legacy)" data-i18n-ko="데모(기존)">데모(기존)</span></a>
      <a href="/demo-sdk" class="active"><span data-i18n-en="Demo (SDK)" data-i18n-ko="데모(SDK)">데모(SDK)</span></a>
      <a href="/sdk-install"><span data-i18n-en="SDK Install Guide" data-i18n-ko="SDK 설치/연동 가이드">SDK 설치/연동 가이드</span></a>
      <a href="/admin" target="_blank"><span data-i18n-en="Admin" data-i18n-ko="관제">관제</span></a>
      <span class="small" style="margin-left:12px;">
        <a href="#" data-lang-toggle="ko">KR</a> /
        <a href="#" data-lang-toggle="en">EN</a>
      </span>
    </div>

    <div class="row"><span class="pill">자동 createRecord + WS ingest 연결</span> <span class="pill">overlay 제공</span> <span class="pill">New Record 버튼으로 체인</span></div>

    <div class="row"><b>SDK state</b></div>
    <div class="row small">recordId: <code id="state_recordId">-</code></div>
    <div class="row small">previousRecordId: <code id="state_prev">-</code></div>
    <div class="row small">shareUrl: <a id="state_shareUrl" href="#" target="_blank">-</a></div>
    <div class="row small">wsUrl: <code id="state_wsUrl">-</code></div>
  </div>

  <div class="box grid">
    <div>
      <div class="row"><b>Console 이벤트</b></div>
      <button id="btnLog">console.log</button>
      <button id="btnWarn">console.warn</button>
      <button id="btnError">console.error</button>
      <button id="btnThrow">throw Error</button>
    </div>
    <div>
      <div class="row"><b>Network 이벤트</b></div>
      <div class="row small">※ 서버의 /demo/api/* 로 호출됩니다.</div>
      <button id="btnFetchOk">fetch GET ok</button>
      <button id="btnFetchSlow">fetch GET slow</button>
      <button id="btnFetchFail">fetch GET fail(500)</button>
      <button id="btnFetchPost">fetch POST echo</button>
      <br/>
      <button id="btnXhrOk">XHR GET ok</button>
      <button id="btnXhrSlow">XHR GET slow</button>
      <button id="btnXhrFail">XHR GET fail(500)</button>
      <button id="btnXhrPost">XHR POST echo</button>
    </div>
  </div>

  <div class="box">
    <div class="row"><b>Breadcrumb 이벤트</b></div>
    <input id="demoInput" placeholder="입력해보세요 (input 기록됨)" style="width: 320px;" />
    <button id="btnCustomBreadcrumb">커스텀 breadcrumb</button>
    <button id="btnPushState">history.pushState</button>
  </div>

  <script src="/sdk/recordroom-sdk.js"></script>
  <script>
    (function () {
      // Start SDK (auto create/attach, overlay on)
      RecordRoom.start({
        apiBase: window.location.origin,
        appVersion: "0.5.0",
        overlay: true,
        reuseRecordInSession: true,
        autoCreateRecord: true,
        patchConsole: true,
        patchNetwork: true,
        patchBreadcrumb: true
      }).then(function (st) {
        document.getElementById("state_recordId").textContent = st.recordId || "-";
        document.getElementById("state_prev").textContent = st.previousRecordId || "-";
        document.getElementById("state_wsUrl").textContent = st.ingestWsUrl || "-";

        var a = document.getElementById("state_shareUrl");
        if (st.shareUrl) {
          a.textContent = st.shareUrl;
          a.href = st.shareUrl;
        } else {
          a.textContent = "-";
          a.href = "#";
        }
      }).catch(function (e) {
        console.error("RecordRoom.start failed", e);
        alert("RecordRoom.start failed: " + (e && e.message ? e.message : String(e)));
      });

      // Console buttons
      document.getElementById("btnLog").addEventListener("click", function () { console.log("hello", { a: 1, b: 2 }); });
      document.getElementById("btnWarn").addEventListener("click", function () { console.warn("warn happened", { time: new Date().toISOString() }); });
      document.getElementById("btnError").addEventListener("click", function () { console.error("error happened", { code: "E_SDK_DEMO" }); });
      document.getElementById("btnThrow").addEventListener("click", function () { throw new Error("boom! thrown error for sdk demo"); });

      // fetch buttons
      document.getElementById("btnFetchOk").addEventListener("click", async function () {
        var r = await fetch("/demo/api/ok");
        console.log("fetch ok status=", r.status);
      });
      document.getElementById("btnFetchSlow").addEventListener("click", async function () {
        var r = await fetch("/demo/api/slow?ms=700");
        console.log("fetch slow status=", r.status);
      });
      document.getElementById("btnFetchFail").addEventListener("click", async function () {
        var r = await fetch("/demo/api/fail");
        console.log("fetch fail status=", r.status);
      });
      document.getElementById("btnFetchPost").addEventListener("click", async function () {
        var r = await fetch("/demo/api/echo", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ orderId: "O-" + Date.now(), amount: 12000 })
        });
        console.log("fetch post status=", r.status);
      });

      function xhr(method, url, body) {
        return new Promise(function (resolve, reject) {
          var x = new XMLHttpRequest();
          x.open(method, url, true);
          if (body != null) x.setRequestHeader("Content-Type", "application/json");
          x.onload = function () { resolve({ status: x.status, text: x.responseText }); };
          x.onerror = function () { reject(new Error("xhr error")); };
          x.send(body);
        });
      }

      document.getElementById("btnXhrOk").addEventListener("click", async function () {
        var r = await xhr("GET", "/demo/api/ok");
        console.log("xhr ok status=", r.status);
      });
      document.getElementById("btnXhrSlow").addEventListener("click", async function () {
        var r = await xhr("GET", "/demo/api/slow?ms=650");
        console.log("xhr slow status=", r.status);
      });
      document.getElementById("btnXhrFail").addEventListener("click", async function () {
        var r = await xhr("GET", "/demo/api/fail");
        console.log("xhr fail status=", r.status);
      });
      document.getElementById("btnXhrPost").addEventListener("click", async function () {
        var r = await xhr("POST", "/demo/api/echo", JSON.stringify({ userId: "U-" + Date.now(), action: "click" }));
        console.log("xhr post status=", r.status);
      });

      // breadcrumb buttons
      document.getElementById("btnCustomBreadcrumb").addEventListener("click", function () {
        RecordRoom.breadcrumb("custom", "custom breadcrumb clicked", { note: "hello from sdk demo", ts: String(Date.now()) });
      });

      document.getElementById("btnPushState").addEventListener("click", function () {
        history.pushState({ rr: true }, "", "?rr=" + Date.now());
      });

      document.getElementById("demoInput").addEventListener("change", function () { console.log("input changed"); });
    })();
  </script>
</body>
</html>
