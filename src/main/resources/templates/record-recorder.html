<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>기록방 - Recorder</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system; padding: 20px; line-height: 1.6; max-width: 1400px; margin: 0 auto; }
    button, input { padding: 10px 16px; margin: 4px 8px 4px 0; background: #1976d2; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #1565c0; }
    input { background: white; color: #333; border: 1px solid #ddd; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; font-family: ui-monospace, monospace; }
    .box { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 16px 0; background: #fafafa; }
    .row { margin: 8px 0; }
    a { color: #1976d2; text-decoration: none; word-break: break-all; }
    a:hover { text-decoration: underline; }
    .small { color: #666; font-size: 12px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    .tabs { display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:4px 10px; }
    .tabs-main { display:flex; flex-wrap:wrap; align-items:center; gap:10px; }
    .tabs-external { display:flex; flex-wrap:wrap; align-items:center; gap:8px; font-size:12px; }
    .tabs a { text-decoration: none; }
    .tabs a.active { font-weight: 700; text-decoration: underline; }
    .tabs-external a { opacity:0.85; }
    .tabs-external a:hover { opacity:1; text-decoration:underline; }
    .pill { display: inline-block; background: #f4f4f4; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
  </style>
  <script src="/js/i18n.js"></script>
</head>
<body>
  <h1><span data-i18n-en="Recorder" data-i18n-ko="레코더">레코더</span> <span class="small" data-i18n-en="(this page records events)" data-i18n-ko="(이 페이지에서 이벤트를 남김)">(이 페이지에서 이벤트를 남김)</span></h1>

  <div class="box">
    <div class="row"><b>Record ID</b>: <code id="recordId" th:text="${recordId}">-</code></div>
    <div class="row tabs">
      <div class="tabs-main">
        <a th:href="@{'/r/' + ${recordId} + '/timeline'}"><span data-i18n-en="Timeline" data-i18n-ko="타임라인">타임라인</span></a>
        <a th:href="@{'/r/' + ${recordId} + '/console'}"><span data-i18n-en="Console" data-i18n-ko="콘솔">콘솔</span></a>
        <a th:href="@{'/r/' + ${recordId} + '/network'}"><span data-i18n-en="Network" data-i18n-ko="네트워크">네트워크</span></a>
        <a th:href="@{'/r/' + ${recordId} + '/breadcrumbs'}"><span data-i18n-en="Breadcrumbs" data-i18n-ko="브레드크럼">브레드크럼</span></a>
        <a th:href="@{'/r/' + ${recordId} + '/replay'}"><span data-i18n-en="Replay" data-i18n-ko="리플레이">리플레이</span></a>
        <a th:href="@{'/rec/' + ${recordId}}" class="active"><span data-i18n-en="Recorder" data-i18n-ko="레코더">레코더</span></a>
      </div>
      <div class="tabs-external">
        <a href="/demo" target="_blank"><span data-i18n-en="Demo" data-i18n-ko="데모">데모</span></a>
        <a href="/demo-sdk" target="_blank"><span data-i18n-en="SDK Demo" data-i18n-ko="SDK 데모">SDK 데모</span></a>
        <a href="/sdk-install" target="_blank"><span data-i18n-en="SDK Install" data-i18n-ko="SDK 설치가이드">SDK 설치가이드</span></a>
        <a href="/test-session-chain" target="_blank"><span data-i18n-en="Session Chain Test" data-i18n-ko="세션 체인 테스트">세션 체인 테스트</span></a>
        <a href="/admin" target="_blank"><span data-i18n-en="Admin" data-i18n-ko="관제">관제</span></a>
        <span class="small" style="margin-left:12px;">
          <a href="#" data-lang-toggle="ko">KR</a> /
          <a href="#" data-lang-toggle="en">EN</a>
        </span>
      </div>
    </div>

    <div class="row"><b>Previous</b>: <span class="small" id="prev">loading...</span></div>
    <div class="row"><b>Share URL</b>: <a id="shareUrl" href="#" target="_blank">-</a></div>
    <div class="row"><b>WS</b>: <code id="wsUrl">-</code></div>
    <div class="row small">
      <span class="pill">recorder도 SDK를 사용해서 수집/전송합니다</span>
    </div>
  </div>

  <div class="box">
    <div class="row"><b>신규 기록방 생성</b> (previousRecordId = 현재 recordId)</div>
    <button id="btnNext">다음 기록방 생성 + 이 페이지에서 계속 기록</button>
    <span class="small">※ 버튼 누르면 새로운 recordId로 이동합니다</span>
  </div>

  <div class="box grid">
    <div>
      <div class="row"><b>Console 이벤트</b></div>
      <button id="btnLog">console.log</button>
      <button id="btnWarn">console.warn</button>
      <button id="btnError">console.error</button>
      <button id="btnThrow">throw Error</button>
    </div>
    <div>
      <div class="row"><b>Network 이벤트</b></div>
      <div class="row small">※ 서버의 /demo/api/* 로 호출됩니다.</div>
      <button id="btnFetchOk">fetch GET ok</button>
      <button id="btnFetchSlow">fetch GET slow</button>
      <button id="btnFetchFail">fetch GET fail(500)</button>
      <button id="btnFetchPost">fetch POST echo</button>
      <br/>
      <button id="btnXhrOk">XHR GET ok</button>
      <button id="btnXhrSlow">XHR GET slow</button>
      <button id="btnXhrFail">XHR GET fail(500)</button>
      <button id="btnXhrPost">XHR POST echo</button>
    </div>
  </div>

  <div class="box">
    <div class="row"><b>Breadcrumb 이벤트</b></div>
    <input id="demoInput" placeholder="입력해보세요 (input 기록됨)" style="width: 320px;" />
    <button id="btnCustomBreadcrumb">커스텀 breadcrumb</button>
    <button id="btnPushState">history.pushState</button>
  </div>

  <script src="/sdk/recordroom-sdk.js"></script>

<script th:inline="javascript">
/*<![CDATA[*/
(function(){
  const recordId = [[${recordId}]];
  const apiBase = window.location.origin;

  async function loadMeta(){
    const r = await fetch(apiBase + "/api/records/" + recordId);
    const data = await r.json();

    const prevEl = document.getElementById("prev");
    if (data.previousRecordId) {
      prevEl.innerHTML = "<a href='/r/" + data.previousRecordId + "/timeline'>" + data.previousRecordId + "</a>";
    } else {
      prevEl.textContent = "-";
    }

    const shareUrl = apiBase + "/r/" + recordId + "/timeline";
    const a = document.getElementById("shareUrl");
    a.textContent = shareUrl;
    a.href = shareUrl;

    const wsUrl = apiBase.replace(/^http/, "ws") + "/ws/ingest?recordId=" + recordId;
    document.getElementById("wsUrl").textContent = wsUrl;
  }

  // attach SDK to existing recordId (no overlay here)
  RecordRoom.start({
    apiBase,
    appVersion: "0.5.0",
    overlay: false,
    reuseRecordInSession: false,
    autoCreateRecord: false,
    recordId,
    patchConsole: true,
    patchNetwork: true,
    patchBreadcrumb: true
  }).catch((e) => {
    console.error("RecordRoom.start failed", e);
    alert("RecordRoom.start failed: " + (e && e.message ? e.message : String(e)));
  });

  // Next record: create new and redirect to new recorder page
  document.getElementById("btnNext").addEventListener("click", async () => {
    try {
      const st = await RecordRoom.newRecord({
        apiBase,
        appVersion: "0.5.0",
        overlay: false,
        reuseRecordInSession: false,
        autoCreateRecord: true,
        patchConsole: true,
        patchNetwork: true,
        patchBreadcrumb: true
      });
      window.location.href = "/rec/" + st.recordId;
    } catch (e) {
      console.error("newRecord failed", e);
      alert("newRecord failed: " + (e && e.message ? e.message : String(e)));
    }
  });

  // Buttons
  document.getElementById("btnLog").addEventListener("click", () => console.log("hello", {a:1, b:2}));
  document.getElementById("btnWarn").addEventListener("click", () => console.warn("warn happened", {time: new Date().toISOString()}));
  document.getElementById("btnError").addEventListener("click", () => console.error("error happened", {code:"E_RECORDER"}));
  document.getElementById("btnThrow").addEventListener("click", () => { throw new Error("boom! thrown error for recorder"); });

  document.getElementById("btnFetchOk").addEventListener("click", async () => {
    const r = await fetch("/demo/api/ok");
    console.log("fetch ok status=", r.status);
  });
  document.getElementById("btnFetchSlow").addEventListener("click", async () => {
    const r = await fetch("/demo/api/slow?ms=700");
    console.log("fetch slow status=", r.status);
  });
  document.getElementById("btnFetchFail").addEventListener("click", async () => {
    const r = await fetch("/demo/api/fail");
    console.log("fetch fail status=", r.status);
  });
  document.getElementById("btnFetchPost").addEventListener("click", async () => {
    const r = await fetch("/demo/api/echo", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({orderId:"O-"+Date.now(), amount: 12000})
    });
    console.log("fetch post status=", r.status);
  });

  function xhr(method, url, body){
    return new Promise((resolve, reject) => {
      const x = new XMLHttpRequest();
      x.open(method, url, true);
      if (body != null) x.setRequestHeader("Content-Type","application/json");
      x.onload = () => resolve({status:x.status, text:x.responseText});
      x.onerror = () => reject(new Error("xhr error"));
      x.send(body);
    });
  }

  document.getElementById("btnXhrOk").addEventListener("click", async () => {
    const r = await xhr("GET", "/demo/api/ok");
    console.log("xhr ok status=", r.status);
  });
  document.getElementById("btnXhrSlow").addEventListener("click", async () => {
    const r = await xhr("GET", "/demo/api/slow?ms=650");
    console.log("xhr slow status=", r.status);
  });
  document.getElementById("btnXhrFail").addEventListener("click", async () => {
    const r = await xhr("GET", "/demo/api/fail");
    console.log("xhr fail status=", r.status);
  });
  document.getElementById("btnXhrPost").addEventListener("click", async () => {
    const r = await xhr("POST", "/demo/api/echo", JSON.stringify({userId:"U-"+Date.now(), action:"click"}));
    console.log("xhr post status=", r.status);
  });

  document.getElementById("btnCustomBreadcrumb").addEventListener("click", () => {
    RecordRoom.breadcrumb("custom", "custom breadcrumb clicked", { note: "hello from recorder", ts: String(Date.now()) });
  });

  document.getElementById("btnPushState").addEventListener("click", () => {
    history.pushState({rec:true}, "", "?rec=" + Date.now());
  });

  document.getElementById("demoInput").addEventListener("change", () => console.log("input changed"));

  loadMeta();
})();
 /*]]>*/
</script>
</body>
</html>
